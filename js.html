<script>
    Vue.use(VueMaterial.default)

    let app = {
        name: "CSR Programme",
        session: "form",
        hasError: false,
        error: null,
    }

    let form = {
        title: "CSR Programme",
        subTitle: "Required *",
        valid: false,
        submitting: false,
        confirmation: null,
        items: [
            {
                label: "Name",
                value: null,
                required: true,
                valid: null,
                error: "Name can't be empty",
            },
            {
                label: "Address",
                value: null,
                required: true,
                valid: null,
                error: "Address can't be empty",
            },
            {
                label: "Mobile Phone No.",
                value: null,
                required: false,
                valid: true,
                error: "Mobile phone number is invalid",
            }
        ],

    }

    let data = {
        app,
        form,
    }

    let validate = function(item){
        // validate the input filed
        if (item.required){
            if (item.value === "" || item.value === null){
                item.valid = false
            }else{
                item.valid = true
            }
        }
        // validate the form
        for (let i = 0; i < this.form.items.length; i++){
            let item = this.form.items[i]
            this.form.valid = true
            if (item.required && item.valid !== true){
                this.form.valid = false
                break
            }
        }
    }

    let submit = function(){
        this.form.submitting = true
        let headers = ["Timestamp"]
        let values = [new Date()]
        let sheetname = "Responses"
        this.form.items.forEach(item => {
            headers.push(item.label)
            values.push(item.value)
        })
        let data = {headers, values, sheetname}
        data = JSON.stringify(data)
        google.script.run
            .withSuccessHandler(number=>{
                this.form.confirmation = `<p>Thanks for your registration, ${this.form.items[0].value}. 
                Your registration number is <b>${number}<\/b>.<\/p>`
                // reset the form
                this.form.submitting = false
                this.form.valid = false
                this.form.items.forEach(item => {
                    item.value = null
                    item.valid = null
                })
                // got to session confirmation
                this.app.session = "confirmation"
            })
            .withFailureHandler(error=>{
                this.form.submitting = false
                this.app.hasError = true
                this.app.error = error.message
            })
            .saveDataToSheet(data)
    }
    
    let methods = {
        validate,
        submit,
    }

    new Vue({
        el: "#app",
        data,
        methods,
    })
</script>